name: Debug Keepalive Auth

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  test-app-token:
    name: "Test 1: GitHub App Token Minting"
    runs-on: ubuntu-latest
    environment: agent-standard
    steps:
      - name: Mint WORKFLOWS_APP token
        id: workflows_app
        continue-on-error: true
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.WORKFLOWS_APP_ID || '0' }}
          private-key: ${{ secrets.WORKFLOWS_APP_PRIVATE_KEY || 'dummy' }}

      - name: Mint KEEPALIVE_APP token
        id: keepalive_app
        continue-on-error: true
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.KEEPALIVE_APP_ID || '0' }}
          private-key: ${{ secrets.KEEPALIVE_APP_PRIVATE_KEY || 'dummy' }}

      - name: Report App token results
        env:
          WORKFLOWS_TOKEN: ${{ steps.workflows_app.outputs.token || '' }}
          WORKFLOWS_OUTCOME: ${{ steps.workflows_app.outcome }}
          KEEPALIVE_TOKEN: ${{ steps.keepalive_app.outputs.token || '' }}
          KEEPALIVE_OUTCOME: ${{ steps.keepalive_app.outcome }}
          HAS_WORKFLOWS_ID: ${{ secrets.WORKFLOWS_APP_ID != '' }}
          HAS_WORKFLOWS_KEY: ${{ secrets.WORKFLOWS_APP_PRIVATE_KEY != '' }}
          HAS_KEEPALIVE_ID: ${{ secrets.KEEPALIVE_APP_ID != '' }}
          HAS_KEEPALIVE_KEY: ${{ secrets.KEEPALIVE_APP_PRIVATE_KEY != '' }}
        run: |
          set -euo pipefail
          echo "=== GitHub App Token Diagnostic ==="
          echo ""
          echo "--- Secret Presence ---"
          echo "WORKFLOWS_APP_ID present:          $HAS_WORKFLOWS_ID"
          echo "WORKFLOWS_APP_PRIVATE_KEY present: $HAS_WORKFLOWS_KEY"
          echo "KEEPALIVE_APP_ID present:          $HAS_KEEPALIVE_ID"
          echo "KEEPALIVE_APP_PRIVATE_KEY present:  $HAS_KEEPALIVE_KEY"
          echo ""
          echo "--- Token Mint Results ---"
          echo "WORKFLOWS_APP mint outcome: $WORKFLOWS_OUTCOME"
          if [ -n "$WORKFLOWS_TOKEN" ]; then
            echo "WORKFLOWS_APP token: OBTAINED (length=${#WORKFLOWS_TOKEN})"
          else
            echo "WORKFLOWS_APP token: FAILED TO OBTAIN"
          fi
          echo "KEEPALIVE_APP mint outcome: $KEEPALIVE_OUTCOME"
          if [ -n "$KEEPALIVE_TOKEN" ]; then
            echo "KEEPALIVE_APP token: OBTAINED (length=${#KEEPALIVE_TOKEN})"
          else
            echo "KEEPALIVE_APP token: FAILED TO OBTAIN"
          fi

      - name: Test WORKFLOWS_APP token API access
        if: steps.workflows_app.outputs.token != ''
        env:
          GH_TOKEN: ${{ steps.workflows_app.outputs.token }}
        run: |
          set -euo pipefail
          echo "--- Testing WORKFLOWS_APP token API access ---"

          echo "1. Check authenticated identity:"
          curl -sf -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/installation/repositories?per_page=1 | \
            python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          print(f'  Total repos accessible: {data.get(\"total_count\", \"unknown\")}')
          repos = data.get('repositories', [])
          if repos:
              print(f'  First repo: {repos[0][\"full_name\"]}')
          " || echo "  API call failed!"

          echo ""
          echo "2. Check push access to this repo:"
          curl -sf -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY" | \
            python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          perms = data.get('permissions', {})
          print(f'  push: {perms.get(\"push\", \"unknown\")}')
          print(f'  admin: {perms.get(\"admin\", \"unknown\")}')
          print(f'  maintain: {perms.get(\"maintain\", \"unknown\")}')
          " || echo "  Repo access check failed!"

      - name: Test KEEPALIVE_APP token API access
        if: steps.keepalive_app.outputs.token != ''
        env:
          GH_TOKEN: ${{ steps.keepalive_app.outputs.token }}
        run: |
          set -euo pipefail
          echo "--- Testing KEEPALIVE_APP token API access ---"

          echo "1. Check authenticated identity:"
          curl -sf -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/installation/repositories?per_page=1 | \
            python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          print(f'  Total repos accessible: {data.get(\"total_count\", \"unknown\")}')
          repos = data.get('repositories', [])
          if repos:
              print(f'  First repo: {repos[0][\"full_name\"]}')
          " || echo "  API call failed!"

          echo ""
          echo "2. Check push access to this repo:"
          curl -sf -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY" | \
            python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          perms = data.get('permissions', {})
          print(f'  push: {perms.get(\"push\", \"unknown\")}')
          print(f'  admin: {perms.get(\"admin\", \"unknown\")}')
          print(f'  maintain: {perms.get(\"maintain\", \"unknown\")}')
          " || echo "  Repo access check failed!"

  test-claude-auth:
    name: "Test 2: Claude Auth JSON Validation"
    runs-on: ubuntu-latest
    environment: agent-standard
    steps:
      - name: Check CLAUDE_AUTH_JSON secret structure
        env:
          AUTH_JSON: ${{ secrets.CLAUDE_AUTH_JSON || '' }}
        run: |
          set -euo pipefail
          echo "=== Claude Auth JSON Diagnostic ==="
          echo ""

          if [ -z "$AUTH_JSON" ]; then
            echo "RESULT: CLAUDE_AUTH_JSON is EMPTY or not set"
            echo "::error::CLAUDE_AUTH_JSON secret is missing from agent-standard environment"
            exit 1
          fi

          echo "CLAUDE_AUTH_JSON is present (length=${#AUTH_JSON})"
          echo ""

          # Validate it's valid JSON
          echo "--- JSON Validity ---"
          if echo "$AUTH_JSON" | python3 -m json.tool > /dev/null 2>&1; then
            echo "Valid JSON: YES"
          else
            echo "Valid JSON: NO"
            echo "::error::CLAUDE_AUTH_JSON is not valid JSON!"
            # Show first/last chars to help debug without revealing secret
            echo "First 5 chars: $(echo "$AUTH_JSON" | head -c 5)"
            echo "Last 5 chars: $(echo "$AUTH_JSON" | tail -c 5)"
            exit 1
          fi

          # Check structure (top-level keys only - no secret values)
          echo ""
          echo "--- JSON Structure (top-level keys) ---"
          echo "$AUTH_JSON" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          if isinstance(data, dict):
              print(f'Type: object with {len(data)} key(s)')
              for key in sorted(data.keys()):
                  val = data[key]
                  if isinstance(val, dict):
                      print(f'  {key}: object with keys [{', '.join(sorted(val.keys()))}]')
                  elif isinstance(val, str):
                      print(f'  {key}: string (length={len(val)})')
                  elif isinstance(val, list):
                      print(f'  {key}: array (length={len(val)})')
                  elif isinstance(val, bool):
                      print(f'  {key}: bool = {val}')
                  elif isinstance(val, (int, float)):
                      print(f'  {key}: number')
                  elif val is None:
                      print(f'  {key}: null')
                  else:
                      print(f'  {key}: {type(val).__name__}')
          elif isinstance(data, list):
              print(f'Type: array with {len(data)} element(s)')
          else:
              print(f'Type: {type(data).__name__}')
          "

          # Check for expected Claude auth patterns
          echo ""
          echo "--- Auth Pattern Detection ---"
          echo "$AUTH_JSON" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          if not isinstance(data, dict):
              print('WARNING: Expected a JSON object at top level')
              sys.exit(0)

          # Check for common Claude auth patterns
          patterns_found = []
          if 'claudeAiOauth' in data:
              patterns_found.append('claudeAiOauth (Claude.ai OAuth)')
              oauth = data['claudeAiOauth']
              if isinstance(oauth, dict):
                  if 'token' in oauth:
                      tok = oauth['token']
                      print(f'  claudeAiOauth.token: present (length={len(tok)})')
                      # Check if it looks like a valid token (starts with expected prefix)
                      if tok.startswith('sk-ant-'):
                          print(f'  Token prefix: sk-ant-* (session key)')
                      elif tok.startswith('eyJ'):
                          print(f'  Token prefix: eyJ* (JWT-like)')
                      else:
                          prefix = tok[:6] + '...' if len(tok) > 6 else '***'
                          print(f'  Token prefix: {prefix}')
                  else:
                      print('  WARNING: claudeAiOauth missing \"token\" key')
                  if 'expiresAt' in oauth:
                      print(f'  claudeAiOauth.expiresAt: {oauth[\"expiresAt\"]}')
                      # Check if expired
                      from datetime import datetime
                      try:
                          exp = oauth['expiresAt']
                          if isinstance(exp, str):
                              # Try ISO format
                              exp_dt = datetime.fromisoformat(exp.replace('Z', '+00:00'))
                              now = datetime.now(exp_dt.tzinfo)
                              if exp_dt < now:
                                  print(f'  WARNING: Token appears EXPIRED (expired {now - exp_dt} ago)')
                              else:
                                  print(f'  Token expires in: {exp_dt - now}')
                      except Exception as e:
                          print(f'  Could not parse expiry: {e}')
          if 'apiKey' in data or 'api_key' in data:
              patterns_found.append('API key')
              key = data.get('apiKey') or data.get('api_key')
              if isinstance(key, str):
                  print(f'  API key present (length={len(key)})')
          if 'sessionKey' in data:
              patterns_found.append('sessionKey')
          if 'oauthAccount' in data:
              patterns_found.append('oauthAccount')

          if patterns_found:
              print(f'Auth patterns found: {', '.join(patterns_found)}')
          else:
              print(f'WARNING: No recognized auth patterns found in keys: {list(data.keys())}')
              print('Expected one of: claudeAiOauth, apiKey, api_key, sessionKey')
          "

      - name: Test Claude CLI auth (install + dry run)
        env:
          AUTH_JSON: ${{ secrets.CLAUDE_AUTH_JSON || '' }}
        run: |
          set -euo pipefail
          if [ -z "$AUTH_JSON" ]; then
            echo "Skipping CLI test - no auth JSON"
            exit 0
          fi

          echo "--- Installing Claude CLI ---"
          npm install -g @anthropic-ai/claude-code 2>&1 | tail -3
          echo ""

          if ! command -v claude >/dev/null 2>&1; then
            echo "::error::Claude CLI failed to install"
            exit 1
          fi
          echo "Claude CLI installed: $(claude --version 2>&1 || echo 'version unknown')"

          echo ""
          echo "--- Writing auth.json ---"
          mkdir -p "$HOME/.config/claude"
          printf '%s' "$AUTH_JSON" > "$HOME/.config/claude/auth.json"
          chmod 0600 "$HOME/.config/claude/auth.json"
          echo "Written to ~/.config/claude/auth.json"

          echo ""
          echo "--- Testing Claude CLI with minimal prompt ---"
          set +e
          timeout 60 claude -p "Respond with exactly: AUTH_OK" --max-turns 1 2>&1
          status=$?
          set -e
          echo ""
          echo "Claude CLI exit code: $status"
          if [ $status -eq 0 ]; then
            echo "RESULT: Claude CLI auth is WORKING"
          else
            echo "RESULT: Claude CLI auth FAILED (exit code $status)"
            echo "::error::Claude CLI returned exit code $status"
          fi

  test-pat-tokens:
    name: "Test 3: PAT Token Availability"
    runs-on: ubuntu-latest
    environment: agent-standard
    steps:
      - name: Check all PAT secrets
        env:
          HAS_SERVICE_BOT: ${{ secrets.SERVICE_BOT_PAT != '' }}
          HAS_ACTIONS_BOT: ${{ secrets.ACTIONS_BOT_PAT != '' }}
          HAS_CODESPACES: ${{ secrets.CODESPACES_WORKFLOWS != '' }}
          HAS_OWNER_PR: ${{ secrets.OWNER_PR_PAT != '' }}
          HAS_AGENTS_AUTO: ${{ secrets.AGENTS_AUTOMATION_PAT != '' }}
          HAS_CODEX_AUTH: ${{ secrets.CODEX_AUTH_JSON != '' }}
          HAS_CLAUDE_AUTH: ${{ secrets.CLAUDE_AUTH_JSON != '' }}
          HAS_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY != '' }}
        run: |
          set -euo pipefail
          echo "=== PAT / Secret Availability ==="
          echo ""
          echo "SERVICE_BOT_PAT:       $HAS_SERVICE_BOT"
          echo "ACTIONS_BOT_PAT:       $HAS_ACTIONS_BOT"
          echo "CODESPACES_WORKFLOWS:  $HAS_CODESPACES"
          echo "OWNER_PR_PAT:          $HAS_OWNER_PR"
          echo "AGENTS_AUTOMATION_PAT: $HAS_AGENTS_AUTO"
          echo "CODEX_AUTH_JSON:       $HAS_CODEX_AUTH"
          echo "CLAUDE_AUTH_JSON:      $HAS_CLAUDE_AUTH"
          echo "OPENAI_API_KEY:        $HAS_OPENAI_KEY"

  summary:
    name: "Diagnostic Summary"
    needs: [test-app-token, test-claude-auth, test-pat-tokens]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Print summary
        env:
          APP_RESULT: ${{ needs.test-app-token.result }}
          CLAUDE_RESULT: ${{ needs.test-claude-auth.result }}
          PAT_RESULT: ${{ needs.test-pat-tokens.result }}
        run: |
          echo "=== DIAGNOSTIC SUMMARY ==="
          echo ""
          echo "App Token Minting:    $APP_RESULT"
          echo "Claude Auth JSON:     $CLAUDE_RESULT"
          echo "PAT Availability:     $PAT_RESULT"
          echo ""
          if [ "$APP_RESULT" = "success" ] && \
             [ "$CLAUDE_RESULT" = "success" ] && \
             [ "$PAT_RESULT" = "success" ]; then
            echo "ALL CHECKS PASSED - issue may be elsewhere"
          else
            echo "FAILURES DETECTED - review individual job logs above"
          fi
