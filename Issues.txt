1. [Agent] [M1] Compute summary metrics + notional breakdown (Class) from canonical tables
## Why
Historical “Class” sheets and run summaries require consistent rollups (asset-class fractions, totals, top movers).

## Scope
Add a computation layer that produces:
- totals by counterparty
- totals by asset class
- notional breakdown fractions for Class charts
- top N exposures and top N changes

## Non-Goals
- LLM chat (separate issue)
- Writing to Excel

## Tasks
- [ ] Add `src/counter_risk/compute/rollups.py`
- [ ] Implement:
- [ ] `compute_totals(exposures_df) -> totals_df`
- [ ] `compute_notional_breakdown(exposures_df) -> breakdown_row`
- [ ] `top_exposures(exposures_df, n=10)`
- [ ] `top_changes(totals_df, n=10)` (when change data exists)
- [ ] Add unit tests on fixtures verifying breakdown sums to ~1.0 when appropriate

## Acceptance Criteria
- [ ] Breakdown fractions sum to 1.0 within tolerance (when data exists)
- [ ] Top exposures lists are deterministic for the fixture inputs


2. [Agent] [M1] Implement end-to-end pipeline orchestrator + run manifest (auditable outputs)
## Why
Operators need a single “Run” action, and maintainers need auditability (inputs, hashes, outputs, summaries).

## Scope
Orchestrate parse -> compute -> historical update -> PPT screenshot replace -> PPT link refresh -> outputs.

## Non-Goals
- Auto-discovery of raw NISA inputs (Milestone 2)
- LLM chat (separate issue)

## Tasks
- [ ] Add `src/counter_risk/pipeline/run.py`
- [ ] Implement `run_pipeline(config_path) -> run_dir`
- [ ] Write outputs to `runs/<as_of_date>/...`
- [ ] Create `manifest.json` including:
- [ ] config snapshot
- [ ] input file hashes
- [ ] output file paths
- [ ] top exposures + top changes per variant
- [ ] warnings (e.g., “PPT links not refreshed”)
- [ ] Add an integration test running pipeline on fixtures into `tmp_path` (with COM refresh skipped)

## Acceptance Criteria
- [ ] Pipeline produces updated historical books + updated PPTX + manifest in one run directory
- [ ] Manifest references files that exist and contains valid JSON


3. [Agent] [M1] Build the non-technical “Runner” (primary UX) that executes the pipeline without a CLI
## Why
End users cannot use the command line and won’t access the repo. They need a button-driven workflow.

## Scope
Implement the chosen Runner approach from Issue 1:
- Excel Runner.xlsm (recommended) OR
- Windows desktop GUI

## Non-Goals
- Implementing pipeline logic (already in core)
- Complex authentication flows

## Tasks
- [ ] Excel Runner path (if chosen):
- [ ] Create `Runner.xlsm` with:
- [ ] date picker (or month selector)
- [ ] “Run All / Run Ex Trend / Run Trend” buttons
- [ ] “Open Output Folder” button
- [ ] calls packaged executable with config arguments
- [ ] displays status + last run result
- [ ] Desktop GUI path (if chosen):
- [ ] simple UI: choose date, choose variants, run, show logs, open output
- [ ] Add a “no CLI” smoke test (launches UI module and exits cleanly)

## Acceptance Criteria
- [ ] A non-technical user can run the monthly workflow via buttons without a CLI
- [ ] Runner writes outputs to standard location and exposes “open output” action


4. [Agent] [M1] Package releases for non-repo users (single-folder install) + versioning
## Why
Users won’t pull from GitHub. Updates must be delivered as a simple drop-in release.

## Scope
Create a reproducible build that outputs a versioned release bundle:
- pipeline executable (or python env bundle)
- templates (pptx, drop-ins if needed)
- default config
- Runner (xlsm or desktop shortcut)
- README “How to run”

## Non-Goals
- Enterprise installer/MSI (unless required later)

## Tasks
- [ ] Add `src/counter_risk/build/release.py` (or scripts/) to assemble release folder
- [ ] Choose packaging tool (PyInstaller preferred for Windows exe)
- [ ] Include a `VERSION` file and embed version into manifest.json
- [ ] Add “Release Checklist” doc (maintainers)
- [ ] Add a CI workflow that builds a release artifact (if allowed)

## Acceptance Criteria
- [ ] A release bundle can be copied to a shared drive and run by a non-technical user
- [ ] Release bundle produces outputs identical to fixture-based run (within defined tolerances)


5. [Agent] [M1] Add LangChain-based “Run Review” chat UI (model selection + guardrails) for maintainers/operators
## Why
You want interactive Q&A on the results (“what changed?”, “top exposures?”, “why did class shift?”) with selectable models.

## Scope
Provide a chat interface inside the Runner (preferred) or as a separate lightweight window that loads run context.

## Non-Goals
- RAG over arbitrary folders
- Complex multi-user chat history storage

## Tasks
- [ ] Add `src/counter_risk/chat/context.py` to load:
- [ ] manifest.json
- [ ] canonical tables saved as CSV/Parquet in the run folder
- [ ] key warnings and deltas
- [ ] Add `src/counter_risk/chat/session.py` with provider/model selection flags
- [ ] Add prompt-injection safeguards (treat workbook text as untrusted)
- [ ] Integrate chat entrypoint into Runner UI (“Ask about this run”)
- [ ] Add minimal tests: context loads and returns non-empty summaries

## Acceptance Criteria
- [ ] User can select provider/model (where keys exist) and ask questions about a run
- [ ] Answers for “top exposures” match manifest-derived values within tolerance


6. [Agent] [M2] Ingest raw NISA Monthly “All Programs” report and generate MOSERS-format CPRS sheets (no VBA)
## Why
Milestone 1 assumes MOSERS-formatted inputs already exist. Milestone 2 removes the manual macro/layout step.

## Scope
Parse raw NISA monthly All Programs workbook and generate a MOSERS-format workbook (CPRS-CH + CPRS-FCM) suitable for the pipeline.

## Non-Goals
- Perfect replication of Excel formatting/macros
- Pulling cash from PDFs (separate issue)

## Tasks
- [ ] Add fixtures: one raw NISA “Monthly All Programs” file (sanitized if needed)
- [ ] Implement `src/counter_risk/parsers/nisa_all_programs.py`
- [ ] Generate MOSERS-format output workbook using an internal template (not “edit in place”)
- [ ] Ensure CPRS-CH and CPRS-FCM outputs match the structure expected by Milestone 1 parsers
- [ ] Add tests comparing generated MOSERS-format workbook against an approved reference (range-level checks)

## Acceptance Criteria
- [ ] Given raw NISA All Programs input, pipeline can run end-to-end without manual Excel macros


7. [Agent] [M2] Ingest raw NISA Monthly “Ex Trend” and “Trend” reports and generate MOSERS-format CPRS sheets
## Why
Ex Trend and Trend have different CPRS-FCM / futures detail behaviors and manual steps today.

## Scope
Add raw NISA ingestion for Ex Trend and Trend and generate MOSERS-format outputs.

## Non-Goals
- Prior-month futures change/sign-flip logic (separate issue)

## Tasks
- [ ] Add fixtures: raw NISA Ex Trend and Trend monthly files
- [ ] Implement `src/counter_risk/parsers/nisa_ex_trend.py` and `nisa_trend.py`
- [ ] Generate MOSERS-format workbooks consistent with Milestone 1 parsers
- [ ] Add tests against reference outputs

## Acceptance Criteria
- [ ] Raw NISA Ex Trend/Trend inputs can be transformed and then fed into the Milestone 1 pipeline


8. [Agent] [M2] Extract CASH amounts from Daily Holdings PDFs and integrate into Repo “Cash” column (All Programs)
## Why
Procedure requires cash amounts from a daily holdings PDF (1-day lag) and manual entry into Repo section.

## Scope
Parse the relevant daily holdings PDF and map cash amounts to Repo counterparties in the All Programs run.

## Non-Goals
- OCR-first approach if tables are extractable (use OCR only as fallback)
- Perfect parsing of every historical PDF variant on day one

## Tasks
- [ ] Add fixtures: 1–2 representative Daily Holdings PDFs (sanitized if needed)
- [ ] Implement `src/counter_risk/parsers/daily_holdings_pdf.py`
- [ ] Extract repo cash by counterparty (ASL, South Street, Buckler, CIBC, Daiwa, etc.)
- [ ] Integrate into exposures rollups and Drop-In filled output
- [ ] Add tests on fixture PDFs (basic sanity: totals > 0, key counterparties present)

## Acceptance Criteria
- [ ] Pipeline fills Repo Cash values automatically for All Programs without manual entry


9. [Agent] [M2] Compute WAL from NISA Monthly Exposure Summary (Exposure Maturity Schedule) and update ex LLC WAL sheet
## Why
WAL is currently manual: fill zeros, remove Return Swaps, compute weighted average life, and type into historical WAL tab.

## Scope
Automate WAL calculation and append to the ex LLC 3 Year workbook.

## Non-Goals
- Guessing WAL without the exposure summary input

## Tasks
- [ ] Add fixtures: representative NISA Monthly Exposure Summary workbook (sanitized if needed)
- [ ] Implement `src/counter_risk/parsers/exposure_maturity_schedule.py`
- [ ] Implement `calculate_wal(exposure_summary_path, px_date) -> float` per procedure
- [ ] Integrate into historical update step for ex LLC WAL sheet
- [ ] Add unit tests using a synthetic workbook + one real fixture

## Acceptance Criteria
- [ ] WAL is computed deterministically and appended automatically in the run


10. [Agent] [M2] Trend futures detail: prior-month alignment, Change column, and sign-flip flagging
## Why
Trend workflow requires: sort by Description, copy prior month notional, compute change, and flag sign flips with an asterisk.

## Scope
Given current and prior MOSERS Trend workbooks, produce a futures detail table with:
- prior_notional
- change
- sign_flip boolean (or “*” marker)

## Non-Goals
- Perfect matching of calendar spread edge-cases on day one (but add heuristics)

## Tasks
- [ ] Implement `src/counter_risk/compute/futures_delta.py`
- [ ] Normalize descriptions (whitespace, contract month patterns) before matching
- [ ] Perform join current vs prior by normalized description; report unmatched rows
- [ ] Compute change and sign flip
- [ ] Output annotated futures detail CSV and optionally write back into MOSERS-format workbook section
- [ ] Add tests with a small synthetic pair of months

## Acceptance Criteria
- [ ] For a provided pair of months, change and sign-flip flags match the reference output for a sample subset
- [ ] Unmatched rows are surfaced clearly in manifest warnings


11. [Agent] [M2] Input auto-discovery from network folders based on as-of date (operator selects date only)
## Why
Non-technical users shouldn’t browse for 6 different files every month if naming conventions and folders are stable.

## Scope
Add rules to discover inputs from known directory roots:
- raw NISA monthly files
- exposure summary
- daily holdings PDF
- templates and historical workbooks

## Non-Goals
- Building an IT-managed service account solution (unless needed later)

## Tasks
- [ ] Add config fields for directory roots and naming patterns
- [ ] Implement `src/counter_risk/io/discover.py`
- [ ] For a given as-of date, locate candidate files; if multiple matches, prompt user in Runner
- [ ] Add “dry-run discovery” view in Runner UI

## Acceptance Criteria
- [ ] For a standard month, operator selects date and the system finds all needed inputs automatically (or prompts with clear choices)


12. [Agent] [M2] Output extensibility framework: add new output types (PPT variants, PDF export, extra tables) without refactoring core
## Why
You want to generate new output types as maintainers change their minds (slides, extra exhibits, etc.) without rewiring everything.

## Scope
Create a simple plugin-like output interface.

## Non-Goals
- Full templating language
- A complex report designer

## Tasks
- [ ] Add `src/counter_risk/outputs/base.py` with an `OutputGenerator` interface
- [ ] Implement existing outputs as generators:
- [ ] Historical workbook updater
- [ ] PPT screenshot updater
- [ ] PPT link refresher
- [ ] Add a PDF export generator (PowerPoint export via COM if available; otherwise skip with warning)
- [ ] Add config to enable/disable outputs per run

## Acceptance Criteria
- [ ] New outputs can be added by implementing one class and registering it in config
- [ ] Disabling an output does not break the pipeline


13. [Agent] [M2] Generate a macro-enabled spreadsheet deliverable (.xlsm) with stable macros and “Run/Refresh” buttons
## Why
Some stakeholders will still want an Excel-native artifact with buttons, even if logic lives in the program.

## Scope
Produce an `.xlsm` output that:
- contains stable VBA modules
- includes a button(s) to run the pipeline / refresh linked charts / open output folder

## Non-Goals
- Making VBA do the core math

## Tasks
- [ ] Store VBA modules in `assets/vba/*.bas`
- [ ] Choose build approach:
- [ ] Base-template `.xlsm` preserved and copied forward (recommended)
- [ ] OR Excel COM import of `.bas` modules (Windows-only)
- [ ] Add `src/counter_risk/build/xlsm.py` to produce the `.xlsm` artifact
- [ ] Add CI-safe tests that validate the `.xlsm` is a valid file and contains expected components (manual verification steps documented)

## Acceptance Criteria
- [ ] Generated `.xlsm` opens cleanly in Excel and exposes the expected buttons/macros
- [ ] Macros do not break when the pipeline version updates


14. [Agent] [M2] Governance, audit, and safety hardening (operator-friendly errors, logs, and LLM safeguards)
## Why
This is operational reporting. We need reliable error handling, auditability, and protection from “weird spreadsheet text” influencing LLM outputs.

## Scope
Harden the system for month-to-month operations.

## Non-Goals
- Enterprise IAM integration (unless required later)

## Tasks
- [ ] Improve manifest.json: include warnings, unmatched mappings, missing inputs, and reconciliation checks
- [ ] Add reconciliation checks:
- [ ] totals in MOSERS CPRS-CH vs computed totals
- [ ] class breakdown sanity
- [ ] Add “operator-friendly” error messages surfaced in Runner UI
- [ ] Add LLM safeguards:
- [ ] strict system prompt boundaries
- [ ] treat workbook cell text as untrusted data
- [ ] log prompts/responses to run folder (optional, configurable)

## Acceptance Criteria
- [ ] Common failure modes produce actionable, non-technical messages
- [ ] Each run produces an auditable record of inputs, outputs, and key checks
